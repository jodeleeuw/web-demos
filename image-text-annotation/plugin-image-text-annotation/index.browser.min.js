var jsPsychImageTextAnnotation=function(t){"use strict";function e(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==n)return;var i,o,a=[],s=!0,r=!1;try{for(n=n.call(t);!(s=(i=n.next()).done)&&(a.push(i.value),!e||a.length!==e);s=!0);}catch(t){r=!0,o=t}finally{try{s||null==n.return||n.return()}finally{if(r)throw o}}return a}(t,e)||n(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){if(t){if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function o(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=n(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var o=0,a=function(){};return{s:a,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,l=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){l=!0,s=t},f:function(){try{r||null==i.return||i.return()}finally{if(l)throw s}}}}var a=function(t){var e=new Set;do{var n,i=o(Reflect.ownKeys(t));try{for(i.s();!(n=i.n()).done;){var a=n.value;e.add([t,a])}}catch(t){i.e(t)}finally{i.f()}}while((t=Reflect.getPrototypeOf(t))&&t!==Object.prototype);return e};const s={name:"sketchpad",parameters:{image:{type:t.ParameterType.IMAGE,default:void 0},prompt:{type:t.ParameterType.HTML_STRING,default:null},regions:{type:t.ParameterType.COMPLEX,default:[],array:!0}}};class r{constructor(t){this.jsPsych=t,this.is_drawing=!1,this.boxes=[],this.deselect_all_flag=!0}trial(t,e){this.display_element=t,this.add_css(),this.renderDisplay(e),this.addEvents(e);for(const t of e.regions){const e=new l(t.left,t.top,this.boxes,this.img_container,this);e.setEndCoords(t.right,t.bottom),e.finishDrawing(),e.setLabel(t.label?t.label:"?"),e.setModifiable(!1)}}renderDisplay(t){let e='<div id="jspsych-annotation-display">';null!==t.prompt&&(e+=`<div id='instructions'>${t.prompt}</div>`),e+=`\n      <div id='main-display'>\n        <div id='annotated-image-container'>\n          <img src="${t.image}" draggable="false"></img>\n        </div>\n        <div id='annotation-options'>\n          <div><input type="radio" id="opt1" name="annotate_label" value="Foo"><label for="opt1">Foo</label></div>\n          <div><input type="radio" id="opt2" name="annotate_label" value="Bar"><label for="opt2">Bar</label></div>\n          <div><input type="radio" id="opt3" name="annotate_label" value=""><label for="opt3"><input id="opt3_text" type="text"></label></div>\n        </div>\n      </div>\n    `,e+="</div>",this.display_element.innerHTML=e,this.img_container=this.display_element.querySelector("#annotated-image-container")}addEvents(t){this.img_container.addEventListener("mousedown",this.start_box);const e=this.display_element.querySelectorAll('input[type="radio"]');for(const t of Array.from(e))t.addEventListener("change",this.handle_radio_change);this.img_container.addEventListener("mousemove",this.sort_boxes),document.addEventListener("mousedown",(()=>{this.deselect_all_flag=!0})),document.addEventListener("click",this.deselect_all),this.display_element.querySelector('input[type="text"]').addEventListener("change",this.add_new_label),this.display_element.querySelector('input[type="text"]').addEventListener("change",this.update_labels)}add_css(){document.querySelector("head").insertAdjacentHTML("beforeend",'<style id="image-text-annotation-styles">\n        #jspsych-annotation-display #main-display {\n          display: flex;\n        }\n\n        #jspsych-annotation-display #annotated-image-container {\n          cursor: crosshair;\n          position: relative;\n        }\n\n        #jspsych-annotation-display #annotated-image-container img {\n          user-select: none;\n          display: block;\n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box {\n          border: 1px solid green;\n          position: absolute;\n          color:green;\n          user-select: none;\n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box:hover {\n          border: 1px solid yellow;\n          color:yellow;\n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box .annotation-box-label {\n          font-size:10px;\n          font-family:monospace;\n          text-align:left;\n          line-height:1em;\n          background-color: rgba(255,255,255,0.5);\n          border-radius: 5px;\n          border: 1px solid rgba(255,255,255,0.5);\n          position:absolute;\n          top:2px;\n          left:2px;\n          padding: 0.25em;\n          user-select: none;\n          cursor: pointer;\n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box .annotation-box-label.selected {\n          border: 1px solid red;\n          color: red;\n        }\n\n        .annotation-box-remove {\n          visibility: hidden;\n          user-select: none;\n          font-size:15px;\n          font-family:monospace;\n          margin:0px;\n          text-align:left;\n          line-height:1em;\n          position: absolute;\n          top:0;\n          right:0;\n          background-color: green;\n          color: white;\n          width:1em;\n          height:1em;\n          text-align: center;\n          cursor: pointer;\n        }\n\n        .annotation-box-resize {\n          visibility: hidden;\n          width: 6px;\n          height: 6px;\n          border-radius: 3px;\n          background-color: green;\n          border: 1px solid white;\n          position: absolute;\n          cursor: pointer;\n          user-select: none;\n        }\n\n        .annotation-box .left {\n          left: -4px;\n        }\n\n        .annotation-box .top {\n          top: -4px;\n        }\n\n        .annotation-box .right {\n          right: -4px;\n        }\n\n        .annotation-box .bottom {\n          bottom: -4px;\n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box.modifiable:hover .annotation-box-remove {\n          visibility: visible;\n          \n        }\n\n        #jspsych-annotation-display #annotated-image-container .annotation-box.modifiable:hover .annotation-box-resize {\n          visibility: visible;\n        }\n\n        #jspsych-annotation-display #annotation-options {\n          text-align: left;\n          padding-left: 24px;\n        }\n      </style>')}start_box(t){const e=Math.round(t.clientX-this.img_container.getBoundingClientRect().left),n=Math.round(t.clientY-this.img_container.getBoundingClientRect().top);this.is_drawing=!0,this.active_box=new l(e,n,this.boxes,this.img_container,this),this.img_container.addEventListener("mousemove",this.move_box),this.img_container.addEventListener("mouseup",this.stop_box)}move_box(t){if(this.is_drawing){const e=Math.round(t.clientX-this.img_container.getBoundingClientRect().left),n=Math.round(t.clientY-this.img_container.getBoundingClientRect().top);this.active_box.setEndCoords(e,n)}}stop_box(){this.is_drawing&&(this.active_box.finishDrawing(),this.active_box.setLabel(this.active_label),this.active_box.select(),this.active_box=null,this.img_container.removeEventListener("mousemove",this.move_box),this.is_drawing=!1,this.deselect_all_flag=!1)}sort_boxes(){const t=this.boxes.map((t=>t.area())),e=this.boxes.map((t=>t.area()));e.sort(((t,e)=>e-t));let n=0;for(const i of e)this.boxes[t.indexOf(i)].setZIndex(n.toString()),n++}select_label(t){const e=this.display_element.querySelector(`input[value='${t}']`);if(e)e.checked=!0;else{const t=this.display_element.querySelectorAll('input[type="radio"]');for(const e of Array.from(t))e.checked=!1}}handle_radio_change(t){this.active_label=t.target.value;for(const t of this.boxes)t.isSelected()&&t.setLabel(this.active_label)}deselect_all(t){if(this.deselect_all_flag&&!["RADIO","LABEL","INPUT"].includes(t.target.tagName))for(const t of this.boxes)t.deselect()}add_new_label(t){const e=this.display_element.querySelector("#annotation-options"),n=e.querySelectorAll('input[type="radio"]').length,i=`\n      <div><input type="radio" id="opt${n+1}" name="annotate_label" value=""><label for="${n+1}"><input id="opt${n+1}_text" type="text"></label></div>\n    `;e.insertAdjacentHTML("beforeend",i),e.querySelector(`#opt${n+1}_text`).addEventListener("change",this.add_new_label),e.querySelector(`#opt${n+1}_text`).addEventListener("change",this.update_labels),t.target.removeEventListener("change",this.add_new_label),e.querySelector(`#opt${n+1}`).addEventListener("change",this.handle_radio_change)}update_labels(t){const e=t.target,n=e.parentElement.parentElement.querySelector('input[type="radio"]'),i=n.value,o=e.value;for(const t of this.boxes)t.getLabel()==i&&t.setLabel(o);n.value=o}}r.info=s;class l{constructor(t,n,i,s,r){this.label="?",this.selected=!1,this.modifiable=!0,function(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=i.include,r=i.exclude,l=function(t){var e=function(e){return"string"==typeof e?t===e:e.test(t)};return s?s.some(e):!r||!r.some(e)},d=o(a(t.constructor.prototype));try{for(d.s();!(n=d.n()).done;){var h=e(n.value,2),c=h[0],p=h[1];if("constructor"!==p&&l(p)){var u=Reflect.getOwnPropertyDescriptor(c,p);u&&"function"==typeof u.value&&(t[p]=t[p].bind(t))}}}catch(t){d.e(t)}finally{d.f()}}(this),this.container=s,this.box_list=i,this.plugin=r,this.setAnchorCoords(t,n);const l=document.createElement("div");l.classList.add("annotation-box","modifiable"),l.style.left=`${t}px`,l.style.top=`${n}px`,this.element=l,this.container.appendChild(this.element)}setModifiable(t){this.modifiable=t,t?this.element.classList.add("modifiable"):this.element.classList.remove("modifiable")}setLabel(t){t&&(this.label=t),this.element.querySelector(".annotation-box-label").innerHTML=this.label}getLabel(){return this.label}getElement(){return this.element}setAnchorCoords(t,e){this.start_x=t,this.start_y=e}setEndCoords(t,e){this.end_x=t,this.end_y=e,this.updateRenderLocation()}translate(t,e){this.start_x+=t,this.start_y+=e,this.end_x+=t,this.end_y+=e,this.updateRenderLocation()}updateRenderLocation(){this.element.style.width=`${Math.abs(this.end_x-this.start_x)}px`,this.element.style.height=`${Math.abs(this.end_y-this.start_y)}px`,this.start_x<=this.end_x?this.element.style.left=`${this.start_x}px`:this.element.style.left=`${this.end_x}px`,this.start_y<=this.end_y?this.element.style.top=`${this.start_y}px`:this.element.style.top=`${this.end_y}px`}finishDrawing(){this.element.innerHTML='\n      <span class="annotation-box-label"></span>\n      <span class="annotation-box-remove">X</span>\n      <div class="annotation-box-resize top left"></div>\n      <div class="annotation-box-resize top right"></div>\n      <div class="annotation-box-resize bottom left"></div>\n      <div class="annotation-box-resize bottom right"></div>\n    ',this.box_list.push(this),this.addEvents()}addEvents(){this.element.querySelector(".annotation-box-remove").addEventListener("mousedown",(t=>{t.stopPropagation()})),this.element.querySelector(".annotation-box-remove").addEventListener("mouseup",(t=>{t.stopPropagation()})),this.element.querySelector(".annotation-box-remove").addEventListener("click",(t=>{t.preventDefault(),this.remove()})),this.element.querySelector(".annotation-box-resize.bottom.right").addEventListener("mousedown",(t=>{const e=this.element.getBoundingClientRect(),n=this.container.getBoundingClientRect();this.setAnchorCoords(e.left-n.left,e.top-n.top),t.stopPropagation(),this.startMove()})),this.element.querySelector(".annotation-box-resize.bottom.left").addEventListener("mousedown",(t=>{const e=this.element.getBoundingClientRect(),n=this.container.getBoundingClientRect();this.setAnchorCoords(e.right-n.left,e.top-n.top),t.stopPropagation(),this.startMove()})),this.element.querySelector(".annotation-box-resize.top.right").addEventListener("mousedown",(t=>{const e=this.element.getBoundingClientRect(),n=this.container.getBoundingClientRect();this.setAnchorCoords(e.left-n.left,e.bottom-n.top),t.stopPropagation(),this.startMove()})),this.element.querySelector(".annotation-box-resize.top.left").addEventListener("mousedown",(t=>{const e=this.element.getBoundingClientRect(),n=this.container.getBoundingClientRect();this.setAnchorCoords(e.right-n.left,e.bottom-n.top),t.stopPropagation(),this.startMove()})),this.container.addEventListener("mouseup",(()=>{this.stopMove()})),this.element.querySelector(".annotation-box-label").addEventListener("click",(t=>{t.stopPropagation(),this.select()})),this.element.querySelector(".annotation-box-label").addEventListener("mousedown",(t=>{this.modifiable&&this.startDrag(t),t.stopPropagation()}))}startMove(){this.container.addEventListener("mousemove",this.moveHandler)}moveHandler(t){const e=this.container.getBoundingClientRect();let n=Math.round(t.clientX-e.left),i=Math.round(t.clientY-e.top);n=Math.min(n,e.width),n=Math.max(n,0),i=Math.min(i,e.height),i=Math.max(i,0),this.setEndCoords(n,i)}stopMove(){this.container.removeEventListener("mousemove",this.moveHandler)}startDrag(t){this.drag_offset_x=Math.round(t.clientX-this.container.getBoundingClientRect().left)-this.start_x,this.drag_offset_y=Math.round(t.clientY-this.container.getBoundingClientRect().top)-this.start_y,this.container.addEventListener("mousemove",this.dragHandler),this.container.addEventListener("mouseup",this.stopDrag)}stopDrag(){this.container.removeEventListener("mousemove",this.dragHandler),this.container.removeEventListener("mouseup",this.stopDrag)}dragHandler(t){const e=this.container.getBoundingClientRect(),n=Math.round(t.clientX-e.left),i=Math.round(t.clientY-e.top),o=n-this.drag_offset_x-this.start_x,a=i-this.drag_offset_y-this.start_y;this.start_x+o<e.width&&this.end_x+o<e.width&&this.start_x+o>0&&this.end_x+o>0&&this.start_y+a<e.height&&this.end_y+a<e.height&&this.start_y+a>0&&this.start_y+a>0&&this.translate(o,a)}area(){const{width:t,height:e}=this.element.getBoundingClientRect();return t*e}setZIndex(t){this.element.style.zIndex=t}remove(){this.element.remove(),this.box_list=this.box_list.filter((t=>{}))}select(){for(const t of this.box_list)t.deselect();this.selected=!0,this.element.querySelector(".annotation-box-label").classList.add("selected"),this.plugin.select_label(this.label)}deselect(){this.selected=!1,this.element.querySelector(".annotation-box-label").classList.remove("selected")}isSelected(){return this.selected}showResizeHandles(){this.element.querySelectorAll(".annotation-box-resize")}}return r}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
